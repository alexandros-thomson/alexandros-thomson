# Issue #133: Credential Validation for Auth0 & Third-Party Providers

**Phase:** Phase 2 - Integration & Validation  
**Milestone:** Auth0 deployment and security hardening  
**Labels:** `auth0`, `phase-2`, `security`, `credentials`, `testing`  
**Priority:** High

## Overview

Validate all Auth0 credentials and third-party provider integrations (SendGrid SMTP, Google OAuth2, GitHub Actions secrets) to ensure they're correctly configured and functional before production launch.

## Current State

- SendGrid SMTP: ✓ Configured in Auth0
- Google OAuth2: ✓ Credentials obtained and entered
- GitHub Actions Secrets: ✓ AUTH0_CLIENT_ID and AUTH0_CLIENT_SECRET stored
- **Missing:** Formal validation and test results

## Required Validation Tests

### Test 1: SendGrid SMTP Connectivity

**Objective:** Verify Auth0 can send emails via SendGrid

**Steps:**

1. In **Auth0 Dashboard > Branding > Email Provider**  
2. Confirm settings:  
   - **From Email:** `noreply@kypria.com`  
   - **SMTP Host:** `smtp.sendgrid.net`  
   - **SMTP Port:** `587`  
   - **Username:** `apikey`  
   - **Password:** `SG.xxxxx...` (masked)

3. Click **"Send Test Email"** button  
4. Enter your test email address  
5. Verify email arrives in inbox within 1 minute

**Expected Result:**
```
✓ Email successfully sent from noreply@kypria.com
✓ Test email received with Auth0 test content
✓ No spam folder
```

**Troubleshooting if Failed:**
- Check SendGrid API key is valid: `curl -X GET https://api.sendgrid.com/v3/scopes -H "Authorization: Bearer SG.xxxxx"`
- Verify sender email is verified in SendGrid: Dashboard > Sender Verification
- Check Auth0 logs: Logs > Filter by "s_em" (email send) events

**Bash Script to Validate API Key:**
```bash
#!/bin/bash
SENDGRID_API_KEY="SG.xxxxx"

# Test SendGrid API connection
curl -X GET https://api.sendgrid.com/v3/mail/settings/bounce_purge \
  -H "Authorization: Bearer $SENDGRID_API_KEY" \
  -H "Content-Type: application/json"

# Expected: {"bounce_purge_date":null} or similar successful response
```

### Test 2: Google OAuth2 Credentials Validation

**Objective:** Verify Google OAuth2 client ID and secret are valid

**Steps:**

1. In **Auth0 Dashboard > Authentication > Social > Google**  
2. Confirm credentials:  
   - **Client ID:** [from Google Cloud Console]  
   - **Client Secret:** [from Google Cloud Console]  
   - **Scopes:** `profile email`

3. Test Google OAuth flow:
   ```bash
   GOOGLE_CLIENT_ID="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
   GOOGLE_CLIENT_SECRET="YOUR_GOOGLE_CLIENT_SECRET"
   REDIRECT_URI="https://auth.kypriatechnologies.org/login/callback"
   
   # Get authorization code (manually visit this URL or use curl)
   AUTHZ_URL="https://accounts.google.com/o/oauth2/v2/auth?client_id=$GOOGLE_CLIENT_ID&redirect_uri=$REDIRECT_URI&response_type=code&scope=openid%20profile%20email"
   
   echo "Visit: $AUTHZ_URL"
   # After accepting, you'll get a code in the redirect URL
   ```

4. Go to **Auth0 Dashboard > Universal Login**  
5. Login page should show **"Continue with Google"** option  
6. Click it and complete Google OAuth flow  
7. Should redirect back to Auth0 with successful authentication

**Expected Result:**
```
✓ Google login button appears on Auth0 login page
✓ Can click through to Google authentication
✓ Returns to Auth0 with valid ID token
✓ User created in Auth0 (if new)
```

**Troubleshooting if Failed:**
- Verify redirect URIs in Google Cloud Console include: `https://auth.kypriatechnologies.org/login/callback`
- Check JavaScript origins include: `https://auth.kypriatechnologies.org`
- Review Auth0 logs for OAuth errors

**Validation Script:**
```javascript
// Test in browser console on Auth0 login page
fetch('https://genai-10284842558023066.us.auth0.com/oauth/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    client_id: 'YOUR_GOOGLE_CLIENT_ID',
    client_secret: 'YOUR_GOOGLE_CLIENT_SECRET',
    grant_type: 'authorization_code',
    code: 'AUTHORIZATION_CODE_FROM_REDIRECT'
  })
})
.then(r => r.json())
.then(data => console.log('Token Response:', data))
.catch(e => console.error('Error:', e));
```

### Test 3: GitHub Actions Secrets Validation

**Objective:** Verify AUTH0_CLIENT_ID and AUTH0_CLIENT_SECRET work for M2M auth

**Steps:**

1. Go to **GitHub > Settings > Secrets and variables > Actions**  
2. Verify secrets exist:  
   - [ ] `AUTH0_CLIENT_ID` = `sklAZUaVS44EyWD8LgyDFuhQ9ovgHYeg`  
   - [ ] `AUTH0_CLIENT_SECRET` = [securely stored]

3. Test M2M authentication:
   ```bash
   #!/bin/bash
   CLIENT_ID="sklAZUaVS44EyWD8LgyDFuhQ9ovgHYeg"
   CLIENT_SECRET="YOUR_CLIENT_SECRET"
   DOMAIN="genai-10284842558023066.us.auth0.com"
   
   # Request Management API token
   TOKEN_RESPONSE=$(curl --silent --request POST \
     --url https://$DOMAIN/oauth/token \
     --header 'content-type: application/json' \
     --data "{
       \"client_id\":\"$CLIENT_ID\",\
       \"client_secret\":\"$CLIENT_SECRET\",\
       \"audience\":\"https://$DOMAIN/api/v2/\",
       \"grant_type\":\"client_credentials\"\
     }")
   
   TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
   
   if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
     echo "✓ M2M token obtained successfully"
     echo "Token: ${TOKEN:0:20}..."
   else
     echo "✗ Failed to obtain M2M token"
     echo "Response: $TOKEN_RESPONSE"
     exit 1
   fi
   ```

4. Verify token can call Management API:
   ```bash
   TOKEN="YOUR_TOKEN_FROM_ABOVE"
   DOMAIN="genai-10284842558023066.us.auth0.com"
   
   # Get current tenant info
   curl --request GET \
     --url https://$DOMAIN/api/v2/tenants/settings \
     --header "Authorization: Bearer $TOKEN" \
     --header 'content-type: application/json'
   
   # Expected: Returns tenant configuration JSON
   ```

**Expected Result:**
```
✓ M2M authentication successful
✓ Access token obtained with valid JWT format
✓ Token contains "aud": "https://DOMAIN/api/v2/"
✓ Management API calls succeed with token
```

**Troubleshooting if Failed:**
- Verify CLIENT_SECRET is exactly as stored in Auth0 (no extra spaces)
- Confirm M2M app has "Management API" scope enabled
- Check GitHub Actions logs for exact error message

### Test 4: Auth0 Application Configuration Validation

**Objective:** Verify all Auth0 app settings are correctly configured

**Bash Script to Validate:**
```bash
#!/bin/bash
TOKEN="YOUR_M2M_TOKEN"
DOMAIN="genai-10284842558023066.us.auth0.com"
APP_NAME="Kypria Native App"

# Get application by name
APP=$(curl --silent --request GET \
  --url "https://$DOMAIN/api/v2/applications?name=$APP_NAME" \
  --header "Authorization: Bearer $TOKEN" \
  --header 'content-type: application/json')

echo "Application Configuration:"
echo $APP | jq '.[] | {
  name,
  client_id,
  callbacks,
  allowed_logout_urls,
  allowed_origins
}'

# Expected: Shows all callback URLs, logout URLs, and origins configured correctly
```

### Test 5: Email Template Validation

**Objective:** Verify custom email templates are deployed and functional

**Steps:**

1. In **Auth0 Dashboard > Branding > Email Templates**  
2. Confirm templates exist:  
   - [ ] Welcome Email  
   - [ ] Verification Email  
   - [ ] Password Reset  
   - [ ] Change Password  
   - [ ] Blocked Account

3. For each template:  
   - Click **"Try"** button  
   - Enter test email address  
   - Verify email arrives and displays correctly  
   - Check Liquid variables ({{ user.email }}, {{ link }}) are populated

**Expected Result:**
```
✓ All templates exist
✓ Test emails send successfully
✓ Variables are interpolated correctly
✓ HTML formatting renders properly
```

### Test 6: Custom Error Page Validation

**Objective:** Verify custom error page displays correctly during auth failures

**Steps:**

1. In **Auth0 Dashboard > Settings > Error Pages**  
2. Confirm settings:  
   - [ ] "Redirect users to your own error page" is selected  
   - [ ] Error page URL is set to your custom error page

3. Trigger an authentication error:
   ```bash
   # Use invalid redirect_uri to trigger error
   curl -X GET "https://auth.kypriatechnologies.org/authorize?client_id=INVALID&response_type=code&redirect_uri=https://invalid.com"
   ```

4. Should redirect to your custom error page with error parameters in URL

**Expected Result:**
```
✓ Custom error page displays
✓ Error message is readable
✓ Error code appears in URL (error=invalid_request)
✓ Branding is consistent with app
```

### Test 7: Callback URL Validation

**Objective:** Verify all callback URLs work correctly

**Test Matrix:**

| URL | Platform | Protocol | Test Method |
|-----|----------|----------|------------|
| `https://myapp.org/callback` | Web | HTTPS | Test login redirects here |
| `https://auth.kypriatechnologies.org/callback` | Custom Domain | HTTPS | Test with custom domain |
| `http://localhost:3000/callback` | Local Dev | HTTP | Test in local environment |
| `com.kypria.app://callback` | iOS | Custom Scheme | Test with native app SDK |
| `com.kypria.app://callback` | Android | Custom Scheme | Test with native app SDK |

**Bash Script to Check HTTPS URLs:**
```bash
#!/bin/bash
URLS=(
  "https://myapp.org/callback"
  "https://auth.kypriatechnologies.org/callback"
)

for url in "${URLS[@]}"; do
  echo "Testing: $url"
  STATUS=$(curl -o /dev/null -s -w "%{http_code}" $url)
  if [ $STATUS -eq 200 ] || [ $STATUS -eq 405 ]; then
    echo "✓ $url is accessible"
  else
    echo "✗ $url returned HTTP $STATUS"
  fi
done
```

## Validation Checklist

- [ ] SendGrid test email sent and received successfully
- [ ] Google OAuth2 credentials work for authentication
- [ ] GitHub Actions secrets are set correctly
- [ ] M2M authentication succeeds with valid token
- [ ] Management API calls succeed with token
- [ ] All email templates exist and send correctly
- [ ] Custom error page displays on errors
- [ ] All callback URLs return 200 or 405 (expected HTTP codes)
- [ ] Logo displays on Universal Login page
- [ ] Refresh token rotation is enabled

## Test Results Documentation

After completing all tests, document results:

```markdown
## Validation Results

### SendGrid SMTP
- [x] Test email sent successfully
- [x] Email received in inbox
- [x] No issues reported

### Google OAuth2
- [x] Credentials verified
- [x] Login flow works
- [x] User created successfully

### GitHub Actions
- [x] Secrets present
- [x] M2M authentication works
- [x] Management API accessible

### Auth0 Configuration
- [x] All settings correct
- [x] Email templates deployed
- [x] Callback URLs configured
- [x] Custom domain verified

### Ready for Production: YES ✓
```

## Dependencies

- **Depends on:** #130 (Application Settings), #131 (Custom Domain), #132 (GitHub Actions)
- **Blocks:** #135 (Production Launch Checklist)

## Troubleshooting Guide

| Error | Cause | Solution |
|-------|-------|----------|
| "Invalid API Key" | SendGrid key expired or wrong | Regenerate in SendGrid dashboard |
| "Redirect URI mismatch" | Callback URL not registered | Add exact URL to allowed callbacks |
| "invalid_client" (M2M) | Client secret wrong | Verify exact value in Auth0 |
| "Email not received" | Sender not verified in SendGrid | Add noreply@kypria.com to verified senders |
| "CORS error" | Origin not in allowed list | Add domain to Allowed Web Origins |

## Security Validation

- [ ] No credentials logged in GitHub Actions output
- [ ] Secrets are masked in workflow logs
- [ ] SSL/TLS certificates valid on all HTTPS URLs
- [ ] API keys never exposed in error messages
- [ ] M2M token expiration set to reasonable time

## Sign-Off

Once all tests pass, stakeholders should sign off:

- [ ] Tech Lead: Credentials valid and secure
- [ ] DevOps: GitHub Actions secrets configured correctly
- [ ] QA: All integration tests passed
- [ ] Product: Auth0 configuration meets requirements

## Resources

- [SendGrid SMTP Integration Troubleshooting](https://docs.sendgrid.com/for-developers/sending-email/integrations#auth0)
- [Google OAuth2 Troubleshooting](https://developers.google.com/identity/protocols/oauth2/troubleshooting)
- [Auth0 Management API Reference](https://auth0.com/docs/api/management/v2)
- [GitHub Actions Secrets](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions)

---

**Estimated Effort:** 2 hours
**Owner:** @alexandros-thomson
**Status:** Ready for Implementation