# Issue #131: Custom Domain Selection and Auth0 Configuration

**Phase:** Phase 1 - Core Infrastructure  
**Milestone:** Auth0 deployment and security hardening  
**Labels:** `auth0`, `phase-1`, `dns`, `custom-domain`, `security`  
**Priority:** Critical

## Overview

Configure a custom Auth0 domain (`auth.kypriatechnologies.org`) to replace the default tenant domain (`genai-10284842558023066.us.auth0.com`). This improves branding, security, and user trust.

## Current State

- Auth0 Domain: `genai-10284842558023066.us.auth0.com` (default)  
- Custom Domain: **Not configured**  
- DNS Control: ✓ Have access to kypriatechnologies.org registrar  
- SSL Certificate: Will use Auth0-managed (recommended)

## Decision: kypriatechnologies.org vs kypria.com

**Chosen:** `auth.kypriatechnologies.org`

**Rationale:**  
- Aligns with legal entity name (Kypria Technologies)  
- Signals enterprise-grade security  
- More formal, trustworthy for B2B interactions  
- Consistent with corporate branding

Alternative rejected: `auth.kypria.com` (shorter but less formal)

## Required Changes

### Step 1: Enable Custom Domain in Auth0

1. Navigate to **Auth0 Dashboard > Branding > Custom Domains**  
2. Click **"Add Domain"** (or **"Set Up Custom Domain"**)  
3. Enter domain: `auth.kypriatechnologies.org`  
4. Select Certificate Management:  
   - **Recommended:** Auth0-managed certificate (automatic renewal)  
   - Alternative: Self-managed certificate (manual renewal required)  
5. Click **"Create"** or **"Next"**

### Step 2: Capture CNAME Record from Auth0

Auth0 will display a CNAME record like:  
```
Name: auth.kypriatechnologies.org
Type: CNAME
Value: [something].auth0.com
TTL: 3600
```

**Save this CNAME record** - you'll need it for Step 3.

### Step 3: Add CNAME Record to Domain Registrar

1. Log into your domain registrar (GoDaddy, Namecheap, Route53, etc.)  
2. Navigate to **DNS Settings** for `kypriatechnologies.org`  
3. Add a new DNS record:  
   - **Type:** CNAME  
   - **Name:** `auth`  
   - **Value:** [The CNAME value from Step 2]  
   - **TTL:** 3600 (or automatic)  
4. Save DNS changes

**Important Notes:**  
- Some registrars call it "Points to" instead of "Value"  
- Do NOT include the domain suffix when entering the name (just `auth`, not `auth.kypriatechnologies.org`)  
- DNS propagation typically takes 5-30 minutes, sometimes up to 2 hours

### Step 4: Verify DNS Propagation

Before returning to Auth0, verify DNS is propagated:

```bash
# Check DNS propagation
nslookup auth.kypriatechnologies.org

# Or use dig
dig auth.kypriatechnologies.org CNAME

# Or use curl to trace
curl -v https://auth.kypriatechnologies.org
```

**Expected output:**  
```
auth.kypriatechnologies.org canonical name = [something].auth0.com
```

### Step 5: Verify Custom Domain in Auth0

1. Return to **Auth0 Dashboard > Branding > Custom Domains**  
2. Find your domain (`auth.kypriatechnologies.org`)  
3. Click **"Verify"** button  
4. Auth0 will check DNS propagation:  
   - ✓ If successful: Domain is verified, SSL certificate will be provisioned  
   - ✗ If failed: Wait 10-15 minutes and retry

### Step 6: Test Custom Domain

Once verified:

1. Click **"Test"** to validate the custom domain works  
2. You should see Auth0's login page at: `https://auth.kypriatechnologies.org`  
3. Verify SSL certificate is valid (no warnings)  
4. Test login flow: `curl -I https://auth.kypriatechnologies.org/login`

## Configuration Details

| Property | Value |
|----------|-------|
| **Custom Domain** | `auth.kypriatechnologies.org` |
| **Certificate Type** | Auth0-managed (auto-renewal) |
| **Primary Domain** | `kypriatechnologies.org` |
| **Subdomain** | `auth` |
| **DNS Record Type** | CNAME |
| **Protocol** | HTTPS (automatic) |
| **Default Domain** | `genai-10284842558023066.us.auth0.com` (will coexist during transition) |

## Post-Configuration Updates Required

**After successful verification, you must update:**

1. **Application Callback URLs** (Issue #130)  
   - Add: `https://auth.kypriatechnologies.org/callback`  
   - Keep existing URLs during transition period

2. **Email Templates** (Already configured)  
   - Enable: "Use Custom Domain in Emails"  
   - Ensures password reset links use branded domain

3. **GitHub Actions Secrets** (Optional)  
   - Can update `AUTH0_DOMAIN` to use custom domain  
   - Or keep original for M2M auth, use custom domain for user-facing URLs

4. **Environment Variables** (in your app)  
   - Update `AUTH0_DOMAIN` to `auth.kypriatechnologies.org`  
   - Update `REACT_APP_AUTH0_DOMAIN` if using CRA

## Rollback Plan

If custom domain verification fails:

1. Remove CNAME record from registrar DNS  
2. Delete custom domain from Auth0  
3. Revert to default domain: `genai-10284842558023066.us.auth0.com`  
4. Applications continue working with default domain

This is non-destructive; all user sessions remain valid.

## Security Considerations

- ✓ SSL/TLS automatically managed by Auth0  
- ✓ Reduces phishing risk (users see trusted domain)  
- ✓ Improves brand recognition  
- ✓ Maintains same security posture as default domain  
- ✓ No additional credentials or secrets needed

## Dependencies

- **Depends on:** #130 (Application Settings must be prepared)  
- **Blocks:** #132 (GitHub Actions needs to know the domain)  
- **Related:** #133 (Credential validation)

## Verification Checklist

- [ ] CNAME record added to registrar DNS  
- [ ] DNS propagation verified with `nslookup` or `dig`  
- [ ] Custom domain verified in Auth0 Dashboard  
- [ ] SSL certificate is valid (no browser warnings)  
- [ ] Test login works at `https://auth.kypriatechnologies.org`  
- [ ] Callback URLs in application settings include new domain  
- [ ] Email templates updated to use custom domain  
- [ ] Old default domain still works (for gradual migration)

## Troubleshooting

### "Domain Verification Failed"
- **Cause:** DNS hasn't propagated or CNAME is incorrect  
- **Solution:** Wait 15+ minutes, verify CNAME in registrar is correct, check with `nslookup`

### "SSL Certificate Error"
- **Cause:** Auth0 hasn't provisioned certificate yet  
- **Solution:** Wait 5-10 minutes, clear browser cache, try incognito window

### "Callback URL Mismatch After Setup"
- **Cause:** Application settings weren't updated with new domain  
- **Solution:** Add `https://auth.kypriatechnologies.org/callback` to allowed callback URLs in Issue #130

## Timeline

| Phase | Duration | Action |
|-------|----------|--------|
| DNS Configuration | 5-10 min | Add CNAME to registrar |
| DNS Propagation | 5-30 min | Wait for global DNS sync |
| Auth0 Verification | 1-2 min | Click verify in Auth0 |
| SSL Provisioning | 5-10 min | Auth0 provisions certificate |
| **Total** | **20-60 min** | Custom domain ready |

## Resources

- [Auth0 Custom Domains Documentation](https://auth0.com/docs/customize/custom-domains)  
- [DNS CNAME Records Explanation](https://support.dnsimple.com/articles/cname-record/)  
- [Test DNS Propagation](https://www.whatsmydns.net/)  
- [SSL Certificate Checker](https://www.sslshopper.com/ssl-checker.html)

---

**Estimated Effort:** 45 minutes (mostly waiting for DNS propagation)  
**Owner:** @alexandros-thomson  
**Status:** Ready for Implementation